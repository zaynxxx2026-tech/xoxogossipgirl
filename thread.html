<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Tip Thread | V1.0 OFFICIAL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />
    <!-- Firebase SDKs are now loaded dynamically in script to avoid blocking first paint -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,opsz,wght@0,6..96,400..900;1,6..96,400..900&display=swap" rel="stylesheet">

    <style>
        :root {
            --gold-primary: #D4AF37;
            --gold-light: #F2D06B;
            --pink-neon: #FF007F;
            --blue-electric: #007AFF;

            --glass-surface: rgba(20, 20, 20, 0.75);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-highlight: rgba(255, 255, 255, 0.18);
            --glass-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.9);

            --liquid-gold: linear-gradient(135deg, #BF953F 0%, #FCF6BA 40%, #AA771C 100%);
            --liquid-dark: linear-gradient(180deg, #1a1a1a 0%, #000000 100%);

            --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.15);
            --ease-silk: cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        /* Fixed BiDi Support */
        .gg-rtl {
            direction: rtl !important;
            text-align: right !important;
            unicode-bidi: isolate !important;
        }

        .gg-auto {
            unicode-bidi: plaintext !important;
            text-align: start !important;
            direction: auto !important;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro", "SF Arabic", "Segoe UI", Roboto, sans-serif; letter-spacing: -0.015em; }

        @media (prefers-reduced-motion: reduce) {
            * { transition: none !important; animation: none !important; scroll-behavior: auto !important; }
        }

        @keyframes liquidReveal { 0% { opacity: 0; transform: translateY(30px) scale(0.96); filter: blur(10px); } 100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); } }

        body {
            background: #000; color: #fff; margin: 0;
            background-image:
                radial-gradient(circle at 50% 0%, rgba(212, 175, 55, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 10% 90%, rgba(255, 0, 127, 0.08) 0%, transparent 40%),
                linear-gradient(to bottom, #050505, #000000);
            background-attachment: fixed;
            overflow-x: hidden; -webkit-font-smoothing: antialiased;
            padding-bottom: calc(140px + env(safe-area-inset-bottom));
        }

        .content-wrapper { animation: liquidReveal 0.8s var(--ease-silk) forwards; }

        .liquid-card {
            background: var(--glass-surface); backdrop-filter: blur(45px) saturate(180%);
            -webkit-backdrop-filter: blur(45px) saturate(180%); border: 1px solid var(--glass-border);
            border-top: 1px solid var(--glass-highlight); border-radius: 28px; box-shadow: var(--glass-shadow);
            transition: transform 0.4s var(--ease-spring); transform: translateZ(0); position: relative;
        }

        header {
            position: fixed; top: 0; width: 100%; z-index: 1000; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(25px);
            border-bottom: 1px solid rgba(255,255,255,0.05); transform: translateZ(0);
        }

        .container { max-width: 480px; margin: 0 auto; padding: 80px 20px 20px; width: 100%; }

        .badge { display:inline-flex; align-items:center; padding:4px 10px; border-radius:10px; font-size:9px; font-weight:700; text-transform:uppercase; margin-right:6px; margin-bottom:8px; border:1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); white-space:nowrap; letter-spacing:0.5px; }
        .b-gg { background:var(--liquid-gold); color:#000; box-shadow: 0 0 20px rgba(212,175,55,0.3); border:none; font-weight:800; }
        .b-new { background:#fff; color:#000; border:none; font-weight:800; }
        .b-verify { background:rgba(255,255,255,0.08); color:#fff; }
        .b-hot { background: rgba(255, 0, 127, 0.15); color:var(--pink-neon); border-color:var(--pink-neon); box-shadow:0 0 15px rgba(255,0,127,0.25); }

        .v-indicator { background:var(--blue-electric); color:white; min-width:16px; height:16px; border-radius:50%; font-size:9px; display:inline-flex; align-items:center; justify-content:center; margin-left:6px; box-shadow:0 0 10px rgba(0,122,255,0.6); font-weight:800; padding:0 4px; }

        .input-wrapper { position: fixed; bottom: calc(20px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%) translateZ(0); width: 92%; max-width: 450px; z-index: 9999; }

        .input-bar { display:flex; align-items:center; gap:12px; padding:8px 10px 8px 20px; border-radius:40px; background: rgba(20,20,20,0.9) !important; backdrop-filter: blur(40px) saturate(200%); box-shadow: 0 10px 40px rgba(0,0,0,0.8), inset 0 1px 1px rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); }

        #ci { flex:1; background:transparent; border:none; color:#fff; font-size:16px; padding:12px 0; outline:none; font-weight:400; }
        #ci::placeholder { color: rgba(255,255,255,0.3); }

        .action-btn { width:44px; height:44px; border-radius:50%; border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:0.3s cubic-bezier(0.175,0.885,0.32,1.275); }
        .action-btn:active { transform: scale(0.8); }
        .btn-send { background:var(--liquid-gold); color:#000; font-weight:700; font-size:18px; box-shadow: 0 5px 15px rgba(212,175,55,0.3); }

        .verify-btn, .share-btn { flex:1; height:40px; border-radius:14px; font-size:10px; font-weight:800; text-transform:uppercase; letter-spacing:0.8px; cursor:pointer; transition:0.3s; display:flex; align-items:center; justify-content:center; }
        .verify-btn { background: rgba(0,122,255,0.15); color:#4DAFFF; border:1px solid rgba(0,122,255,0.3); }
        .verify-btn.active { background: var(--blue-electric); color: white; border-color: transparent; box-shadow: 0 0 20px rgba(0,122,255,0.5); }
        
        .verify-btn.admin-verify { background: var(--liquid-gold); color: #000; border: none; box-shadow: 0 0 20px rgba(212,175,55,0.4); }

        .share-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color:#fff; }

        .post-img-preview { width:100%; aspect-ratio:4/3; object-fit:cover; border-radius:20px; margin-bottom:25px; border:1px solid rgba(255,255,255,0.1); display:block; box-shadow:0 10px 30px rgba(0,0,0,0.5); cursor: zoom-in; }

        #lightbox { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:10001; display:none; align-items:center; justify-content:center; backdrop-filter: blur(10px); }
        #lightbox img { max-width:95%; max-height:90%; border-radius:12px; }

        .comment-swipe-zone { position:relative; touch-action: pan-y; margin-bottom:10px; transform: translateZ(0); }

        #ggToast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: var(--liquid-gold); color: #000; padding: 12px 24px; border-radius: 20px; font-weight: 800; font-size: 11px; z-index: 10000; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); letter-spacing: 1px; text-align: center; white-space: nowrap; }
        .empty-state { text-align:center; padding:40px 20px; color: rgba(255,255,255,0.3); font-weight:600; font-size:14px; letter-spacing:0.5px; }

        .main-card { will-change: transform; }
    </style>
</head>
<body>

<div id="ggToast" role="status" aria-live="polite">VERIFIED BY GOSSIP GIRL</div>

<div id="lightbox" role="dialog" aria-modal="true" aria-hidden="true">
    <img src="" id="lightboxImg" alt="Full image">
</div>

<div class="content-wrapper">
    <header>
        <a href="index.html" style="color:var(--gold-primary); text-decoration:none; font-weight:700; font-size:11px; letter-spacing:1px; display:flex; align-items:center; gap:4px;" aria-label="Back to home">
            <span style="font-size:14px;">â€¹</span> BACK
        </a>
        <div style="font-family:'Bodoni Moda', serif; font-style:italic; font-weight:800; letter-spacing:0.5px; font-size:18px; background:var(--liquid-gold); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">Tip Thread</div>
        <div style="width:40px;"></div>
    </header>

    <main class="container" id="mainContainer">
        <div id="postArea" aria-live="polite"></div>

        <div style="margin:35px 0 15px 8px; display:flex; align-items:baseline; gap:10px;">
            <span style="font-weight:800; font-size:24px; letter-spacing:-0.5px; color:#fff;">Comments</span>
            <span id="commentCount" style="font-weight:700; font-size:16px; color:var(--gold-primary); opacity:0.8;">0</span>
        </div>

        <div id="cFeed" aria-live="polite"></div>
    </main>
</div>

<div class="input-wrapper" aria-label="Add a comment">
    <div id="replyBanner" style="display:none; pointer-events:auto; background: rgba(212,175,55,0.15); backdrop-filter: blur(20px); border-radius: 25px 25px 0 0; padding:10px 24px; font-size:10px; font-weight:800; justify-content:space-between; align-items:center; color:var(--gold-primary); border:1px solid rgba(212,175,55,0.3); border-bottom:none; margin:0 20px;">
        <span>REPLYING...</span>
        <span id="replyCancel" role="button" tabindex="0" style="cursor:pointer; background:rgba(0,0,0,0.4); color:#fff; padding:4px 10px; border-radius:12px; font-size:9px;">CANCEL</span>
    </div>

    <div class="liquid-card input-bar" role="form" aria-label="Comment form">
        <input type="text" id="ci" placeholder="Start controversy..." autocomplete="off" aria-label="Comment input">
        <button class="action-btn btn-send" id="cb" aria-label="Send comment">â†‘</button>
    </div>
</div>

<script>
(function(){
    'use strict';

    /* ---------- Utilities ---------- */
    function escapeHTML(s) {
        if (s === null || s === undefined) return '';
        return String(s)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;')
            .replace(/\//g, '&#x2F;');
    }
    function sanitizeForId(str) {
        if (!str) return 'id_unknown';
        return String(str).replace(/[^a-zA-Z0-9-_:.]/g, '_');
    }
    function safeNumber(n){ const v = Number(n); return isNaN(v)?0:v; }
    function timeAgo(t) {
        if(!t) return 'now';
        const s = Math.floor((Date.now() - Number(t)) / 1000);
        if(s < 30) return 'Just now';
        if(s < 3600) return Math.floor(s/60) + 'm ago';
        if(s < 86400) return Math.floor(s/3600) + 'h ago';
        return Math.floor(s/86400) + 'd ago';
    }

    // Important: non-global regex to avoid stateful test issues
    const arabicRegex = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/;

    function applyAutoDirToElement(el){
        if(!el) return;
        const txt = (el.textContent || el.innerText || '').trim();
        if(!txt) return;

        const hasArabic = arabicRegex.test(txt);

        // Ensure classes & attrs are predictable
        el.removeAttribute('dir');
        el.classList.remove('gg-rtl', 'gg-auto');

        if (hasArabic) {
            // use dir=auto + isolated bidi behavior to keep mixed content sane
            el.style.unicodeBidi = 'plaintext';
            el.style.textAlign = 'start';
            el.dir = 'auto';
            el.classList.add('gg-auto');
        } else {
            el.dir = 'ltr';
            el.style.unicodeBidi = 'normal';
        }
    }

    /* Limit mutation observer work: only target nodes likely to contain text needing bidi handling */
    const mutationObserver = new MutationObserver(mutations => {
        try {
            for (const m of mutations) {
                if (!m.addedNodes) continue;
                for (const node of m.addedNodes) {
                    if (!node || node.nodeType !== 1) continue;
                    // Only process if node is a likely content node
                    if (node.classList && (node.classList.contains('post-text-content') || node.classList.contains('liquid-card') || node.classList.contains('main-card') || node.classList.contains('comment-swipe-zone'))) {
                        applyAutoDirToElement(node);
                        continue;
                    }
                    // Also check for any direct child content nodes inside
                    const inner = node.querySelector && node.querySelector('.post-text-content, .liquid-card, .main-card, .comment-swipe-zone');
                    if (inner) applyAutoDirToElement(inner);
                }
            }
        } catch(e){ /* don't let observer crash app */ }
    });
    mutationObserver.observe(document.body, { childList: true, subtree: true });

    /* ---------- Firebase Setup (deferred) ---------- */
    const firebaseConfig = {
        apiKey: "AIzaSyCTdVcJspQxXiq_Kd7ImL32xWsjv0HgENE",
        authDomain: "gossip-girl-4c9f2.firebaseapp.com",
        projectId: "gossip-girl-4c9f2",
        databaseURL: "https://gossip-girl-4c9f2-default-rtdb.firebaseio.com"
    };

    let db = null;
    // helper: load SDKs dynamically if needed, non-blocking
    function ensureFirebaseSDKs(cb) {
        if (typeof firebase !== 'undefined' && firebase && firebase.database) {
            try { if (!firebase.apps || !firebase.apps.length) firebase.initializeApp(firebaseConfig); } catch(e){}
            try { db = firebase.database(); } catch(e){}
            if (cb) cb();
            return;
        }
        const urls = [
            'https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js',
            'https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js'
        ];
        let loaded = 0;
        function onFinish() {
            try {
                if (!firebase.apps || !firebase.apps.length) firebase.initializeApp(firebaseConfig);
            } catch(e){}
            try { db = firebase.database(); } catch(e){ db = null; }
            if (cb) cb();
        }
        urls.forEach(u => {
            const s = document.createElement('script');
            s.src = u;
            s.async = true;
            s.onload = () => { loaded++; if (loaded === urls.length) onFinish(); };
            s.onerror = () => { loaded++; if (loaded === urls.length) onFinish(); };
            document.head.appendChild(s);
        });
    }

    // run after paint to avoid blocking
    function runWhenIdle(fn) {
        if ('requestIdleCallback' in window) requestIdleCallback(fn, {timeout: 1200});
        else setTimeout(fn, 500);
    }

    /* ---------- Page state & DOM refs ---------- */
    const pid = new URLSearchParams(window.location.search).get('id');
    const myUid = localStorage.getItem('gg_id') || 'anon';
    const IS_GG = sessionStorage.getItem('admin_auth') === 'true';

    const postArea = document.getElementById('postArea');
    const cFeed = document.getElementById('cFeed');
    const commentCountEl = document.getElementById('commentCount');
    const ci = document.getElementById('ci');
    const cb = document.getElementById('cb');
    const replyBanner = document.getElementById('replyBanner');
    const replyCancel = document.getElementById('replyCancel');
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightboxImg');
    const ggToast = document.getElementById('ggToast');

    if (!pid) {
        // keep behavior: redirect to index if no pid
        setTimeout(() => { window.location.href = 'index.html'; }, 300);
        return;
    }

    try {
        if (ci) {
            ci.style.unicodeBidi = 'plaintext';
            ci.setAttribute('dir', 'auto');
        }
    } catch (e){}

    let replyToId = null;
    let isSubmitting = false;

    function createTextNodeHTML(text) {
        return escapeHTML(text || '');
    }

    /* ---------- Rendering main post ---------- */
    function renderMainPost(p) {
        if (!postArea) return;
        p = p || {};
        const vCount = safeNumber(p.verifyCount || 0);
        const views = safeNumber(p.views || 0);
        const date = p.date || 0;
        const badges = [];
        if (p.verifiedByGG) badges.push('<span class="badge b-gg">Verified by Gossip Girl</span>');
        if ((Date.now() - date) < 43200000) badges.push('<span class="badge b-new">New</span>');
        if (vCount >= 100) badges.push('<span class="badge b-new" style="background:#fff;color:#000;">Confirmed</span>');

        postArea.innerHTML = '';
        const outer = document.createElement('div');
        outer.className = 'liquid-card post-box';
        outer.style.padding = '24px';
        outer.style.borderRadius = '28px';
        outer.style.position = 'relative';

        const reads = document.createElement('div');
        reads.style.position = 'absolute';
        reads.style.top = '24px';
        reads.style.right = '24px';
        reads.style.fontSize = '10px';
        reads.style.color = 'var(--gold-primary)';
        reads.style.fontWeight = '700';
        reads.style.opacity = '0.8';
        reads.textContent = 'ðŸ‘ ' + views + ' READS';
        outer.appendChild(reads);

        if (badges.length) {
            const bWrap = document.createElement('div');
            bWrap.style.marginBottom = '14px';
            bWrap.style.display = 'flex';
            bWrap.style.flexWrap = 'wrap';
            bWrap.style.maxWidth = '75%';
            bWrap.innerHTML = badges.join('');
            outer.appendChild(bWrap);
        }

        const headerRow = document.createElement('div');
        headerRow.style.display = 'flex';
        headerRow.style.gap = '12px';
        headerRow.style.alignItems = 'center';
        headerRow.style.marginBottom = '20px';

        const avatar = document.createElement('div');
        avatar.style.width = '38px';
        avatar.style.height = '38px';
        avatar.style.background = 'rgba(255,255,255,0.05)';
        avatar.style.borderRadius = '50%';
        avatar.style.display = 'flex';
        avatar.style.alignItems = 'center';
        avatar.style.justifyContent = 'center';
        avatar.style.fontSize = '18px';
        avatar.style.border = '1px solid rgba(255,255,255,0.1)';
        avatar.style.color = 'var(--gold-primary)';
        avatar.style.fontFamily = "'Bodoni Moda'";
        avatar.style.fontStyle = 'italic';
        avatar.textContent = '?';
        headerRow.appendChild(avatar);

        const headerMeta = document.createElement('div');
        headerMeta.style.flex = '1';
        const nameRow = document.createElement('div');
        nameRow.style.display = 'flex';
        nameRow.style.alignItems = 'center';
        const anon = document.createElement('div');
        anon.style.fontWeight = '700';
        anon.style.fontSize = '14px';
        anon.style.color = '#fff';
        anon.textContent = 'Anonymous';
        nameRow.appendChild(anon);

        if (vCount > 0) {
            const vInd = document.createElement('div');
            vInd.className = 'v-indicator';
            vInd.textContent = String(vCount);
            vInd.style.marginLeft = '8px';
            nameRow.appendChild(vInd);
        }

        headerMeta.appendChild(nameRow);
        const timeEl = document.createElement('div');
        timeEl.style.fontSize = '10px';
        timeEl.style.opacity = '0.5';
        timeEl.style.fontWeight = '600';
        timeEl.textContent = timeAgo(date);
        headerMeta.appendChild(timeEl);
        headerRow.appendChild(headerMeta);
        outer.appendChild(headerRow);

        const textDiv = document.createElement('div');
        textDiv.className = 'post-text-content';
        textDiv.style.fontSize = '16px';
        textDiv.style.lineHeight = '1.5';
        textDiv.style.marginBottom = '20px';
        textDiv.style.color = 'rgba(255,255,255,0.92)';
        textDiv.style.fontWeight = '400';
        textDiv.style.letterSpacing = '0.1px';
        textDiv.innerHTML = createTextNodeHTML(p.text);
        outer.appendChild(textDiv);

        try { applyAutoDirToElement(textDiv); } catch(e){}

        if (p.image) {
            const img = document.createElement('img');
            img.className = 'post-img-preview';
            img.alt = 'post image';
            try { img.src = p.image; } catch(e){ img.src = ''; }
            img.loading = 'lazy';
            img.addEventListener('click', () => openLightbox(p.image));
            // ensure crossOrigin where possible to help html2canvas
            try { img.crossOrigin = 'anonymous'; } catch(e){}
            outer.appendChild(img);
        }

        const actionRow = document.createElement('div');
        actionRow.id = 'actionRow';
        actionRow.style.display = 'flex';
        actionRow.style.gap = '12px';
        actionRow.style.justifyContent = 'space-between';
        actionRow.style.alignItems = 'center';
        actionRow.style.borderTop = '1px solid rgba(255,255,255,0.08)';
        actionRow.style.paddingTop = '16px';

        const vBtn = document.createElement('button');
        vBtn.id = 'vBtn';
        vBtn.className = 'verify-btn';
        vBtn.textContent = 'VERIFY';
        
        if (IS_GG) {
            vBtn.classList.add('admin-verify');
        } else if (p.verifiedByGG || (p.verifiers && p.verifiers[myUid])) {
            vBtn.classList.add('active');
        }
        actionRow.appendChild(vBtn);

        const sBtn = document.createElement('button');
        sBtn.id = 'sBtn';
        sBtn.className = 'share-btn';
        sBtn.textContent = 'SHARE';
        actionRow.appendChild(sBtn);

        outer.appendChild(actionRow);
        postArea.appendChild(outer);

        vBtn.addEventListener('click', () => toggleVerify(pid, vBtn));
        sBtn.addEventListener('click', () => shareTip());
    }

    /* ---------- Lightbox ---------- */
    function openLightbox(url) {
        try {
            if (!lightbox || !lightboxImg) return;
            lightboxImg.src = url || '';
            lightbox.style.display = 'flex';
            lightbox.setAttribute('aria-hidden', 'false');
            setTimeout(() => window.addEventListener('keydown', lightboxEsc), 0);
        } catch(e){}
    }
    function closeLightbox() {
        if (!lightbox || !lightboxImg) return;
        lightbox.style.display = 'none';
        lightboxImg.src = '';
        lightbox.setAttribute('aria-hidden', 'true');
        window.removeEventListener('keydown', lightboxEsc);
    }
    function lightboxEsc(e){ if(e.key === 'Escape') closeLightbox(); }

    if (lightbox) {
        lightbox.addEventListener('click', (ev) => {
            if (ev.target === lightbox) closeLightbox();
        });
    }

    /* ---------- Verify logic (transactional) ---------- */
    function toggleVerify(pidLocal, btnEl) {
        if (!db) return;
        const ref = db.ref('posts/' + pidLocal);
        ref.transaction(p => {
            if (!p) return p;
            if (IS_GG) {
                p.verifiedByGG = true;
            } else {
                p.verifiers = p.verifiers || {};
                if (p.verifiers[myUid]) {
                    delete p.verifiers[myUid];
                    p.verifyCount = Math.max(0, safeNumber(p.verifyCount) - 1);
                } else {
                    p.verifiers[myUid] = true;
                    p.verifyCount = safeNumber(p.verifyCount) + 1;
                }
            }
            return p;
        }, (error, committed, snapshot) => {
            if (error) return;
            if (committed && IS_GG) {
                if (ggToast) {
                    ggToast.style.display = 'block';
                    setTimeout(() => ggToast.style.display = 'none', 3000);
                }
            }
            try {
                const newP = snapshot && snapshot.val() ? snapshot.val() : null;
                if (newP && btnEl) {
                    if (IS_GG) {
                        btnEl.classList.add('admin-verify');
                    } else {
                        const has = (newP.verifiedByGG || (newP.verifiers && newP.verifiers[myUid]));
                        btnEl.classList.toggle('active', Boolean(has));
                    }
                }
            } catch(e){}
        });
    }

    /* ---------- Render and setup comments ---------- */
    function renderComments(data) {
        if (!cFeed || !commentCountEl) return;
        data = data || {};
        const keys = Object.keys(data || {});
        if (keys.length === 0) {
            cFeed.innerHTML = '<div class="empty-state">What do you have in mind?</div>';
            commentCountEl.textContent = '0';
            return;
        }

        const main = [];
        const replies = {};
        keys.forEach(k => {
            const c = data[k];
            if (!c) return;
            c.id = k;
            if (c.replyTo) {
                replies[c.replyTo] = replies[c.replyTo] || [];
                replies[c.replyTo].push(c);
            } else main.push(c);
        });

        commentCountEl.textContent = String(keys.length);
        cFeed.innerHTML = '';

        main.sort((a,b) => (safeNumber(b.date) - safeNumber(a.date))).forEach((c, idx) => {
            const wrap = document.createElement('div');
            wrap.className = 'comment-swipe-zone';
            wrap.id = 'wrap-' + sanitizeForId(c.id);
            wrap.style.animation = 'liquidReveal 0.6s cubic-bezier(0.2,0.8,0.2,1) forwards';
            wrap.style.animationDelay = (idx * 0.05) + 's';
            wrap.style.opacity = '0';
            wrap.style.transform = 'translateY(20px)';

            const card = document.createElement('div');
            card.className = 'liquid-card main-card';
            card.style.padding = '18px';
            card.style.position = 'relative';
            card.style.zIndex = '2';
            card.style.transition = 'background 0.2s';

            const headerRow = document.createElement('div');
            headerRow.style.display = 'flex';
            headerRow.style.gap = '10px';
            headerRow.style.marginBottom = '8px';
            headerRow.style.alignItems = 'center';

            const avatar = document.createElement('div');
            avatar.style.width = '28px';
            avatar.style.height = '28px';
            avatar.style.background = 'linear-gradient(135deg, #222, #111)';
            avatar.style.borderRadius = '50%';
            avatar.style.display = 'flex';
            avatar.style.alignItems = 'center';
            avatar.style.justifyContent = 'center';
            avatar.style.fontSize = '12px';
            avatar.style.border = '1px solid rgba(255,255,255,0.1)';
            avatar.style.color = 'var(--gold-primary)';
            avatar.style.fontFamily = "'Bodoni Moda'";
            avatar.style.fontStyle = 'italic';
            avatar.textContent = '?';
            headerRow.appendChild(avatar);

            const meta = document.createElement('div');
            meta.style.flex = '1';
            const name = document.createElement('div');
            name.style.fontWeight = '700';
            name.style.fontSize = '12px';
            name.style.color = '#fff';
            name.textContent = 'Anonymous';
            meta.appendChild(name);
            const t = document.createElement('div');
            t.style.fontSize = '9px';
            t.style.opacity = '0.4';
            t.style.fontWeight = '600';
            t.textContent = timeAgo(c.date);
            meta.appendChild(t);
            headerRow.appendChild(meta);
            card.appendChild(headerRow);

            const txt = document.createElement('div');
            txt.style.fontSize = '13px';
            txt.style.lineHeight = '1.4';
            txt.style.color = 'rgba(255,255,255,0.9)';
            txt.innerHTML = createTextNodeHTML(c.text);
            try { applyAutoDirToElement(txt); } catch(e){}
            card.appendChild(txt);
            wrap.appendChild(card);

            if (replies[c.id]) {
                const repliesWrap = document.createElement('div');
                repliesWrap.style.marginLeft = '20px';
                repliesWrap.style.marginTop = '8px';
                repliesWrap.style.borderLeft = '1.5px solid rgba(255,255,255,0.08)';
                repliesWrap.style.paddingLeft = '12px';
                replies[c.id].forEach(r => {
                    const rCard = document.createElement('div');
                    rCard.className = 'liquid-card';
                    rCard.style.padding = '12px';
                    rCard.style.marginBottom = '8px';
                    rCard.style.borderRadius = '18px';
                    rCard.style.background = 'rgba(255,255,255,0.02)';
                    rCard.style.border = '1px solid rgba(255,255,255,0.04)';
                    const rTag = document.createElement('div');
                    rTag.style.fontWeight = '700';
                    rTag.style.fontSize = '9px';
                    rTag.style.color = 'var(--gold-primary)';
                    rTag.style.marginBottom = '4px';
                    rTag.style.opacity = '0.8';
                    rTag.textContent = 'REPLY';
                    rCard.appendChild(rTag);
                    const rText = document.createElement('div');
                    rText.style.fontSize = '12px';
                    rText.style.opacity = '0.9';
                    rText.style.lineHeight = '1.4';
                    rText.innerHTML = createTextNodeHTML(r.text);
                    try { applyAutoDirToElement(rText); } catch(e){}
                    rCard.appendChild(rText);
                    repliesWrap.appendChild(rCard);
                });
                wrap.appendChild(repliesWrap);
            }
            cFeed.appendChild(wrap);
            setupSwipeHandler(c.id, wrap, card);
        });
    }

    /* ---------- Swipe to reply handler (robust) ---------- */
    function setupSwipeHandler(cid, row, card) {
        if(!row || !card) return;
        let startX = 0, startY = 0, isSwiping = false, isScrolling = false;
        row.addEventListener('touchstart', (e) => {
            startX = e.touches && e.touches[0] ? e.touches[0].clientX : 0;
            startY = e.touches && e.touches[0] ? e.touches[0].clientY : 0;
            isSwiping = false;
            isScrolling = false;
            card.style.transition = 'none';
        }, {passive:true});
        row.addEventListener('touchmove', (e) => {
            if (!e.touches || !e.touches[0]) return;
            const diffX = startX - e.touches[0].clientX;
            const diffY = Math.abs(startY - e.touches[0].clientY);
            if (!isSwiping && !isScrolling) {
                if (diffY > 10) isScrolling = true;
                else if (diffX > 10) isSwiping = true;
            }
            if (isSwiping && diffX > 0) {
                const move = Math.min(diffX, 80);
                requestAnimationFrame(()=> { card.style.transform = `translateX(-${move}px)`; });
                if (diffX > 70 && replyToId !== cid) {
                    replyToId = cid;
                    if (replyBanner) replyBanner.style.display = 'flex';
                    try { if (navigator.vibrate) navigator.vibrate(10); } catch(e){}
                    card.style.background = 'rgba(255,255,255,0.08)';
                }
            }
        }, {passive:true});
        row.addEventListener('touchend', () => {
            card.style.transition = 'transform 0.4s var(--ease-spring), background 0.3s';
            requestAnimationFrame(() => { card.style.transform = 'translateX(0px)'; });
            setTimeout(()=>{ if(!replyToId || replyToId !== cid) card.style.background = ''; }, 400);
        }, {passive:true});
    }

    /* ---------- SHARE / html2canvas improvements ---------- */
    function shareTip() {
        const cap = document.querySelector('.post-box');
        if (!cap) return;

        const actionRow = document.getElementById('actionRow');
        const readsInd = cap.querySelector('div[style*="READS"]');
        const originalImg = cap.querySelector('.post-img-preview');

        if (actionRow) actionRow.style.display = 'none';
        if (readsInd) readsInd.style.display = 'none';

        // Use a lower scale to avoid memory spikes (scale 3 is a good balance)
        // Also wrap in try/catch because html2canvas may fail on some browsers / blocked resources
        try {
            html2canvas(cap, {
                backgroundColor: '#000000',
                scale: 3,
                useCORS: true,
                allowTaint: false,
                letterRendering: true,
                onclone: (clonedDoc) => {
                    try {
                        const clonedImg = clonedDoc.querySelector('.post-img-preview');
                        const clonedText = clonedDoc.querySelector('.post-text-content');

                        if (clonedImg && originalImg) {
                            const width = originalImg.offsetWidth || originalImg.clientWidth || 400;
                            const height = originalImg.offsetHeight || originalImg.clientHeight || Math.round(width * 0.75);
                            const src = originalImg.src || '';
                            const replacement = clonedDoc.createElement('div');
                            replacement.style.width = width + 'px';
                            replacement.style.height = height + 'px';
                            replacement.style.backgroundImage = src ? `url(${src})` : 'none';
                            replacement.style.backgroundSize = 'cover';
                            replacement.style.backgroundPosition = 'center';
                            replacement.style.borderRadius = '20px';
                            replacement.style.marginBottom = '25px';
                            replacement.style.border = '1px solid rgba(255,255,255,0.1)';
                            if (clonedImg.parentNode) clonedImg.parentNode.replaceChild(replacement, clonedImg);
                        }

                        if (clonedText) {
                            const rawTxt = (clonedText.textContent || clonedText.innerText || '').trim();
                            const hasArabic = arabicRegex.test(rawTxt);

                            clonedText.style.letterSpacing = '0px';
                            clonedText.style.wordSpacing = '0px';
                            clonedText.style.whiteSpace = 'pre-wrap';
                            clonedText.style.wordBreak = 'break-word';
                            clonedText.style.lineHeight = '1.6';

                            if (hasArabic) {
                                clonedText.style.direction = 'rtl';
                                clonedText.style.textAlign = 'right';
                                clonedText.style.unicodeBidi = 'isolate';
                                clonedText.setAttribute('dir', 'rtl');
                            } else {
                                clonedText.style.direction = 'ltr';
                                clonedText.style.textAlign = 'left';
                                clonedText.setAttribute('dir', 'ltr');
                            }
                        }
                    } catch(e){}
                }
            }).then(canvas => {
                try {
                    if (actionRow) actionRow.style.display = 'flex';
                    if (readsInd) readsInd.style.display = 'block';

                    canvas.toBlob(blob => {
                        if (!blob) return;
                        const file = new File([blob], 'gossip_girl.png', { type: 'image/png' });
                        if (navigator.canShare && navigator.canShare({ files: [file] })) {
                            try { navigator.share({ files: [file], title: 'Gossip Girl' }); }
                            catch(e){ downloadBlob(blob); }
                        } else {
                            downloadBlob(blob);
                        }
                    }, 'image/png', 1.0);
                } catch(e){
                    if (actionRow) actionRow.style.display = 'flex';
                    if (readsInd) readsInd.style.display = 'block';
                    // fallback: alert and re-show controls
                    console.warn('Share failed', e);
                }
            }).catch(err => {
                if (actionRow) actionRow.style.display = 'flex';
                if (readsInd) readsInd.style.display = 'block';
                console.warn('html2canvas failed', err);
            });
        } catch (ex) {
            if (actionRow) actionRow.style.display = 'flex';
            if (readsInd) readsInd.style.display = 'block';
            console.warn('shareTip unexpected', ex);
        }
    }

    function downloadBlob(blob) {
        try {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gossip_girl.png';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                try { URL.revokeObjectURL(url); } catch(e){}
                try { a.remove(); } catch(e){}
            }, 5000);
        } catch(e){ console.warn('download fallback failed', e); }
    }

    /* ---------- Comment submit ---------- */
    cb && cb.addEventListener('click', () => {
        if (isSubmitting) return;
        const txt = (ci && ci.value) ? ci.value.trim() : '';
        if (!txt || !db) return;
        isSubmitting = true;

        // prefer server timestamp, but fallback to Date.now() if firebase not available
        const payload = { text: txt, date: (firebase && firebase.database && firebase.database.ServerValue && firebase.database.ServerValue.TIMESTAMP) ? firebase.database.ServerValue.TIMESTAMP : Date.now(), replyTo: replyToId || null };

        db.ref('comments/' + pid).push(payload)
        .then(()=> { if (ci) ci.value = ''; cancelReply(); })
        .catch(()=>{})
        .finally(()=> { isSubmitting = false; });
    });

    ci && ci.addEventListener('keypress', (e) => { if (e.key === 'Enter') cb && cb.click(); });

    function cancelReply() {
        replyToId = null;
        if (replyBanner) replyBanner.style.display = 'none';
        document.querySelectorAll('.main-card').forEach(c => {
            c.style.background = '';
            c.style.transform = 'translateX(0px)';
        });
    }
    replyCancel && replyCancel.addEventListener('click', cancelReply);

    /* ---------- Init listeners & data wiring ---------- */
    function initListeners() {
        // If firebase not ready, defer initialization
        if (!db) {
            // try to initialize SDKs and then wire listeners
            runWhenIdle(() => ensureFirebaseSDKs(() => {
                runWhenIdle(() => {
                    try { // re-run wiring if db now available
                        if (!db && typeof firebase !== 'undefined' && firebase && firebase.database) db = firebase.database();
                    } catch(e){}
                    attachDBListeners();
                });
            }));
            return;
        }
        attachDBListeners();
    }

    function attachDBListeners() {
        if (!db) return;
        try {
            // increment views once per client (defensive)
            let viewed = [];
            try { viewed = JSON.parse(localStorage.getItem('gg_viewed_posts') || '[]'); } catch(e){}
            if (!viewed.includes(pid)) {
                try { db.ref('posts/' + pid + '/views').transaction(v => (safeNumber(v) + 1)); } catch(e){}
                viewed.push(pid);
                try { localStorage.setItem('gg_viewed_posts', JSON.stringify(viewed)); } catch(e){}
            }
        } catch(e){}

        try {
            db.ref('comments/' + pid).on('value', snap => renderComments(snap.val() || {}));
            db.ref('posts/' + pid).on('value', snap => {
                const p = snap.val();
                if (!p) { window.location.href = 'index.html'; return; }
                renderMainPost(p);
            });
        } catch(e){
            console.warn('DB listeners attach failed', e);
        }
    }

    // start initialization
    runWhenIdle(() => ensureFirebaseSDKs(() => initListeners()));

    // expose lightbox helpers if needed elsewhere
    window.openLightbox = openLightbox;
    window.closeLightbox = closeLightbox;

})();
</script>
</body>
</html>